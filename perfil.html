<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu Perfil</title>
    <link rel="stylesheet" href="style.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
        rel="stylesheet">

    <!-- Aplica tema salvo e sidebar colapsada -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const body = document.body;
            const savedTheme = localStorage.getItem("theme") || "light";
            body.classList.toggle("dark-theme", savedTheme === "dark");

            const savedCollapse = localStorage.getItem("sidebarCollapsed") === "true";
            if (savedCollapse) document.querySelector(".sidebar")?.classList.add("collapsed");
        });
    </script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <h2 class="logo">MeuApp</h2>
        <nav>
            <a href="dashboard.html">ğŸ  InÃ­cio</a>
            <a href="rendas.html">ğŸ’° Rendas</a>
            <a href="contas.html">ğŸ“‹ Contas</a>
            <a href="alertas.html">ğŸ”” Alertas</a>
            <a href="graficos.html">ğŸ“Š GrÃ¡ficos</a>
            <a href="configuracoes.html">âš™ï¸ ConfiguraÃ§Ãµes</a>
            <a href="#" class="active">ğŸ‘¤ Perfil</a>
            <a href="#" id="logoutBtn">ğŸšª Sair</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <main class="dashboard-container">

        <header class="dashboard-header">
            <button id="toggleSidebar" class="btn-toggle">â˜°</button>
            <button id="toggleTheme" class="btn-toggle">ğŸŒ“</button>
            <h1>Meu Perfil</h1>
            <p>Gerencie suas informaÃ§Ãµes pessoais</p>
        </header>

        <!-- PERFIL DO USUÃRIO -->
        <section class="form-section">
            <h2>InformaÃ§Ãµes do UsuÃ¡rio</h2>

            <div class="profile-card">

                <div class="profile-photo-container">
                    <img id="profilePhoto" class="profile-photo" src="https://via.placeholder.com/150" alt="Foto do usuÃ¡rio">
                    <input type="file" id="photoInput" accept="image/*" />
                </div>

                <div class="profile-info">
                    <label>Nome completo</label>
                    <input type="text" id="userName" placeholder="Seu nome">

                    <label>Email</label>
                    <input type="text" id="userEmail" disabled>

                    <button class="btn-primary" id="saveProfileBtn">Salvar AlteraÃ§Ãµes</button>
                </div>

            </div>
        </section>

    </main>

    <!-- Firebase Auth + Firestore -->
    <script type="module">
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        import {
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const auth = getAuth();
        const db = getFirestore();

        const userNameInput = document.getElementById("userName");
        const userEmailInput = document.getElementById("userEmail");
        const profilePhoto = document.getElementById("profilePhoto");
        const photoInput = document.getElementById("photoInput");

        // Carregar dados do Firestore
        async function loadProfileData(uid) {
            const ref = doc(db, "usuarios", uid);
            const snap = await getDoc(ref);

            if (snap.exists()) {
                const data = snap.data();

                if (data.nome) userNameInput.value = data.nome;
                if (data.foto) profilePhoto.src = data.foto;
            }
        }

        // Salvar dados no Firestore
        async function saveProfileData(uid, data) {
            await setDoc(doc(db, "usuarios", uid), data, { merge: true });
        }

        // Aguardar autenticaÃ§Ã£o
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            userEmailInput.value = user.email;

            await loadProfileData(user.uid);
        });

        // Upload da foto (base64 simples)
        photoInput.addEventListener("change", () => {
            const file = photoInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => (profilePhoto.src = reader.result);
            reader.readAsDataURL(file);
        });

        // Salvando perfil
        document.getElementById("saveProfileBtn").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return;

            const nome = userNameInput.value.trim();
            const foto = profilePhoto.src;

            // Firebase Auth (apenas nome e foto)
            await updateProfile(user, {
                displayName: nome,
                photoURL: foto
            });

            // Firestore
            await saveProfileData(user.uid, {
                nome,
                foto
            });

            alert("Perfil atualizado com sucesso!");
        });

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });

    </script>

    <!-- Sidebar + Tema -->
    <script>
        document.getElementById("toggleSidebar").addEventListener("click", () => {
            const sidebar = document.querySelector(".sidebar");
            sidebar.classList.toggle("collapsed");
            localStorage.setItem("sidebarCollapsed", sidebar.classList.contains("collapsed"));
        });

        document.getElementById("toggleTheme").addEventListener("click", () => {
            const body = document.body;
            body.classList.toggle("dark-theme");
            localStorage.setItem("theme", body.classList.contains("dark-theme") ? "dark" : "light");
        });
    </script>

</body>

</html>
